#!/usr/bin/perl -w
# -*- cperl -*-
#
# Scrollable less-based display streams (MTY::Display::Scrollable)
#
# Copyright 2003 - 2014 Matt T. Yourst <yourst@yourst.com>
#

package MTY::Display::Scrollable;

use integer; use warnings; use Exporter::Lite;

our @EXPORT = # (auto-generated by perl-mod-deps)
  qw($no_scrolling $scroll_program $scroll_program_args $scroll_program_env
     open_scrollable_stream);

use MTY::Common::Common;
use MTY::Common::Strings;
use MTY::Common::EnvVarDefaults;
use MTY::Filesystem::Files;

#pragma end_of_includes

#
# Open a file handle piped to the "less" program; any lines written to
# this file handle will be easily scrollable on screen. The user can
# simply press Ctrl+C or Q to exit the scrollable mode.
#
# To ensure the file handle (and the associated "less" process) are
# closed at the end of the caller's scope, the caller should assign
# the returned file handle to a local variable, as in:
#
# sub example_e_g_show_help() {
#   local $helpfd = open_scrollable_stream();
#   prints($helpfd, ...):
#   ...
#   (at end of $helpfd's scope, it will automatically be closed)
# }
#
# Without this, you always need to manually run close($fd) at the end.
#

our $no_scrolling = 0;
our $scroll_program = 'less';
our $scroll_program_args = q!-A -E -K -R -S -X!;
our $scroll_program_env = q!LESSCHARSET='utf-8' LESSUTFBINFMT='*u%04lx'!;

sub open_scrollable_stream(;$) {
  my ($program, $args, $env) = @_;

  if ($no_scrolling) { return undef; }
  $program //= $scroll_program;
  $args //= $scroll_program_args;
  $env //= $scroll_program_env;

  my $all = '| '.$env.' '.$program.' '.$args;
  my $fd;
  if (!open($fd, $all)) { return undef; }

  binmode $fd, ':utf8';
  return $fd;
}

INIT {
  my %defaults = get_defaults_from_env({
    disable => \$no_scrolling,
    program => \$scroll_program,
    args => \$scroll_program_args,
    env => \$scroll_program_env
  });
};

